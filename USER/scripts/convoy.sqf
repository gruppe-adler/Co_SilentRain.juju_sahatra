private _points = [[15235.8,7558.91,-0.0295563],[15229.8,7557.28,-0.0291595],[15223,7555.41,-0.0291977],[15215.8,7553.44,-0.0289841],[15208,7551.31,-0.0289307],[15199,7548.87,-0.0293236],[15189.4,7546.26,-0.0294647],[15179.9,7543.64,-0.0307388],[15170.1,7540.96,-0.0303078],[15160,7538.21,-0.0302429],[15149.7,7535.39,-0.0301971],[15139.2,7532.53,-0.030262],[15127.7,7529.39,-0.0301857],[15116.7,7526.41,-0.0303497],[15105.3,7523.34,-0.0301285],[15092.8,7520.02,-0.0301781],[15080.7,7516.78,-0.0302162],[15068.3,7513.49,-0.0302315],[15055.9,7510.19,-0.0304871],[15043.5,7506.91,-0.0306931],[15030.6,7503.54,-0.0308113],[15017.3,7500.04,-0.0309296],[15003.7,7496.52,-0.0300522],[14990.9,7493.3,-0.0302696],[14977.6,7489.95,-0.0312195],[14964.6,7486.71,-0.0298004],[14951.1,7483.34,-0.0295982],[14937.6,7479.97,-0.0301857],[14923.8,7476.49,-0.0310478],[14909.2,7472.85,-0.0304375],[14894.3,7469.13,-0.0302887],[14879.5,7465.42,-0.0302238],[14863.7,7461.45,-0.0299606],[14848.1,7457.56,-0.0288467],[14832.1,7453.56,-0.0328217],[14815.2,7449.37,-0.0302391],[14798.7,7445.35,-0.0300407],[14782,7441.32,-0.029335],[14765,7437.42,-0.0305176],[14747.2,7433.39,-0.0308495],[14729.4,7429.37,-0.0301399],[14711.5,7425.31,-0.0311432],[14693.5,7421.19,-0.0299988],[14675.6,7417.06,-0.02985],[14656.8,7412.66,-0.0272484],[14638.8,7408.41,-0.0263481],[14620.3,7404.01,-0.0258904],[14602.3,7399.64,-0.0261459],[14584.2,7395.17,-0.0240059],[14565.5,7390.5,-0.0285072],[14547.7,7386.05,-0.0279922],[14529.1,7381.39,-0.0290527],[14509.7,7376.5,-0.0280762],[14490.1,7371.61,-0.0299721],[14470.4,7366.67,-0.0317154],[14450.6,7361.71,-0.0304756],[14430.3,7356.62,-0.0303383],[14409.1,7351.28,-0.0312538],[14387.8,7345.95,-0.0306396],[14366.5,7340.63,-0.0289688],[14345.7,7335.39,-0.0299606],[14323.8,7329.93,-0.0317116],[14302.2,7324.52,-0.0310287],[14280.3,7319.06,-0.0302505],[14258.7,7313.64,-0.0306091],[14236.9,7308.19,-0.0313492],[14215.2,7302.77,-0.0312538],[14194.1,7297.49,-0.0312958],[14172.9,7292.2,-0.0315399],[14152.1,7287,-0.0310097],[14130.5,7281.59,-0.0307808],[14109.2,7276.26,-0.0307541],[14088,7270.98,-0.0307808],[14066.7,7265.65,-0.030304],[14046.1,7260.49,-0.0271759],[14025,7255.29,-0.0312538],[14003.9,7250.11,-0.0304642],[13982.5,7244.84,-0.0282784],[13961,7239.57,-0.0342216],[13939.3,7234.26,-0.0297813],[13917.4,7228.91,-0.0296593],[13896.2,7223.73,-0.0304604],[13874.6,7218.46,-0.0319252],[13852.9,7213.17,-0.0314789],[13832,7208.09,-0.0325012],[13811.1,7203.01,-0.0352859],[13790.3,7197.94,-0.0294228],[13769.6,7192.92,-0.0300636],[13748,7187.65,-0.0303879],[13726.4,7182.38,-0.0290756],[13705.5,7177.28,-0.0280571],[13684.6,7172.13,-0.0288467],[13664,7167.07,-0.0253143],[13643.5,7162,-0.0256958],[13622.4,7156.81,-0.0249596],[13601.2,7151.56,-0.0284309],[13579.2,7146.14,-0.0303993],[13558.3,7140.99,-0.0298424],[13537.2,7135.77,-0.0302162],[13516.4,7130.63,-0.0301247],[13495.1,7125.36,-0.0280724],[13474,7120.17,-0.0306549],[13452.8,7114.95,-0.03339],[13431.7,7109.77,-0.0319977],[13410.6,7104.59,-0.0310478],[13389.6,7099.4,-0.0296745],[13368.3,7094.13,-0.0303268],[13347,7088.87,-0.0325851],[13326.3,7083.77,-0.0330124],[13305.5,7078.63,-0.0307617],[13283.7,7073.24,-0.0282707],[13261.7,7067.8,-0.0307808],[13239.7,7062.36,-0.0351067],[13218.4,7057.1,-0.0298309],[13196.7,7051.7,-0.0315018],[13175.2,7046.38,-0.0300026],[13153.6,7041.08,-0.0302582],[13132.9,7036,-0.0305595],[13111.9,7030.84,-0.0297966],[13090.7,7025.63,-0.0281296],[13069.8,7020.45,-0.0287704],[13047.6,7015.03,-0.0314331],[13025.9,7009.76,-0.0333252],[13005.1,7004.71,-0.0316391],[12984.1,6999.62,-0.0277214],[12963.2,6994.71,-0.0226212],[12941.9,6990.03,-0.0257187],[12921,6985.16,-0.0269241],[12902,6980.28,-0.0245781],[12881.3,6974.95,-0.0152397],[12860.5,6970.01,0.00705338],[12841.2,6965.69,0.0423164],[12821.3,6961.27,0.024332],[12800.8,6956.21,-0.0724163],[12780.5,6950.15,-0.0358505],[12760.8,6944.02,-0.0524654],[12741.7,6937.76,-0.0337429],[12723,6931.22,-0.0256023],[12704.8,6924.81,-0.0291862],[12686.8,6918.9,0.0153351],[12669.1,6914.15,-0.0247593],[12651.5,6909.91,-0.0312138],[12634.2,6906.17,-0.0279312],[12617.1,6903.07,-0.0325832],[12598.6,6899.85,-0.0314064],[12580.6,6896.77,-0.0322762],[12563.1,6894.11,-0.030056],[12546.5,6891.65,-0.0296631],[12530.5,6889.58,-0.022337],[12516.4,6887.8,-0.0192261],[12501.8,6885.9,-0.0216084],[12488.4,6884.17,-0.0279026],[12475.9,6882.64,-0.0271969],[12463.7,6881.23,-0.0291004],[12451.5,6879.84,-0.0293655],[12439.2,6878.43,-0.0307579],[12426.9,6876.86,-0.0321884],[12414.4,6874.46,-0.0303631],[12402.4,6870.55,-0.0400047],[12390.6,6865.7,-0.0105381],[12379.5,6860.17,-0.0238571],[12369.2,6854.5,-0.0279579],[12359.2,6848.74,-0.0284767],[12348.2,6842.58,-0.0250034],[12337.1,6836.71,-0.0292931],[12326.5,6831.07,-0.0293331],[12315.3,6825.22,-0.0295792],[12304.5,6819.71,-0.0297966],[12292.5,6814.21,-0.0300941],[12280.3,6809.04,-0.0295906],[12268,6803.93,-0.0289993],[12255,6798.65,-0.0280151],[12242.7,6794.01,-0.0292778],[12229.6,6789.23,-0.029171],[12216,6784.38,-0.029953],[12202.7,6779.69,-0.0296059],[12187.9,6774.65,-0.0301094],[12173.1,6769.6,-0.0301933],[12158.4,6764.61,-0.0299988],[12143,6759.38,-0.0301323],[12128.1,6754.38,-0.0300999],[12112.9,6749.46,-0.0300312],[12096.5,6744.27,-0.0295792],[12080.4,6739.2,-0.0296097],[12063.3,6734.06,-0.0295067],[12046.3,6729.12,-0.029623],[12028.8,6723.95,-0.0296116],[12010.2,6718.37,-0.0295296],[11991.6,6712.78,-0.029747],[11973.2,6707.25,-0.0295429],[11952.9,6701.16,-0.0302258],[11933,6695.18,-0.0304146],[11912.4,6688.99,-0.031086],[11892,6682.85,-0.0313683],[11871.2,6676.58,-0.0314331],[11850.2,6670.29,-0.0308475],[11829.5,6664.04,-0.030035],[11808.8,6657.85,-0.0304031],[11787.6,6651.47,-0.0314655],[11766.8,6645.32,-0.0306816],[11745.5,6639.05,-0.0275402],[11724.8,6632.97,-0.0332851],[11704.1,6626.85,-0.0317059],[11683.2,6620.44,-0.0294743],[11661.9,6613.92,-0.030241],[11640.8,6607.62,-0.0319786],[11620.1,6601.41,-0.0319366],[11598.9,6595,-0.03088],[11577.6,6588.52,-0.0308266],[11556.7,6582.1,-0.0314426],[11535.7,6575.62,-0.0314732],[11514.3,6568.94,-0.0310383],[11493.7,6562.55,-0.0300102],[11472.4,6555.91,-0.0295467],[11451.1,6549.27,-0.0305576],[11429.8,6542.62,-0.031435],[11409.4,6536.16,-0.031065],[11388.9,6529.6,-0.0308876],[11367.8,6523.01,-0.0287571],[11347.3,6516.7,-0.0315399],[11326.4,6510.1,-0.0312004],[11305.1,6503.44,-0.0306015],[11283.7,6496.8,-0.0308208],[11262.4,6490.22,-0.0314026],[11241.7,6483.81,-0.0308781],[11220.6,6477.28,-0.0313168],[11200.2,6470.96,-0.0311432],[11179.6,6464.58,-0.0315533],[11158.4,6458,-0.0296059],[11137.9,6451.63,-0.0314102],[11117.6,6445.35,-0.0332737],[11096.6,6438.83,-0.0251408],[11075.7,6432.37,-0.0204468],[11055.6,6426.12,-0.0264969],[11035,6420,-0.02565],[11013.4,6413.78,-0.0251694],[10992.9,6407.84,-0.0383224],[10972,6401.75,-0.0189095],[10951,6395.61,-0.0200424],[10930.1,6389.42,-0.0231323],[10909.6,6383.46,-0.0293388],[10889.1,6377.59,-0.0277557],[10868.3,6371.55,-0.0293121],[10847.2,6365.4,-0.0296097],[10826.7,6359.4,-0.0252304],[10806.3,6353.45,-0.0223274],[10786.4,6347.67,-0.0345917],[10766.2,6341.61,-0.0242386],[10745.6,6334.97,-0.0261421],[10725.6,6328.33,-0.0236168],[10705.6,6321.66,-0.0222206],[10685.8,6315,-0.0248756],[10665.8,6308.69,-0.0248642],[10645.2,6303.32,-0.0175934],[10624.3,6299.56,-0.0202904],[10602.8,6297.06,-0.0273514],[10581.7,6295.32,-0.0266457],[10560.9,6294.47,-0.0236397],[10538.9,6294.96,-0.0230179],[10517.5,6296.42,-0.0278473],[10496,6298.24,-0.0291634],[10474.9,6300.15,-0.0280228],[10453.7,6302.46,-0.0302963],[10431.7,6305.1,-0.0316696],[10410.5,6307.49,-0.0305443],[10388.8,6309.77,-0.0325851],[10367.1,6311.69,-0.0256042],[10345.1,6313.27,-0.0305977],[10323.3,6314.63,-0.0309525],[10301.1,6315.93,-0.0306549],[10279.8,6317.16,-0.0326576],[10258.3,6318.14,-0.0324211],[10236,6317.7,-0.0326195],[10214,6316.02,-0.0309258],[10192.3,6314.02,-0.0313339]];



private _startedVarName = "SH_convoyStarted";
missionNamespace setVariable [_startedVarName,true,true];

private _dir = 255;

private _convoyVehicles = [
    ["rhsgref_cdf_btr70",[15253.2,7563.85,-1.90735e-006]],
    ["rhsgref_cdf_ural_open", [15268.2,7567.61,-5.72205e-006], true],
    ["rhsgref_cdf_ural_open", [15282.8,7571.09,1.90735e-006], true],
    ["rhsgref_cdf_btr70", [15293.2,7575.02,-5.72205e-005]],
    ["rhsgref_cdf_ural_fuel",[15306.2,7578.76,-0.000341415]],
    ["rhsgref_cdf_gaz66_ammo", [15316.9,7581.18,0]]
];





private _convoy = [];

{   
    _x params ["_classname", "_position", ["_hasCargo", false]];

    private _veh = ([_position,_dir,_classname,independent] call BIS_fnc_spawnVehicle) select 0;

     if (_hasCargo) then {

        private _cargoGroup = [ 
            _position, 
            independent, 
            ["rhsgref_cdf_ngd_officer", "rhsgref_cdf_ngd_rifleman_ak74", "rhsgref_cdf_ngd_rifleman_ak74", "rhsgref_cdf_ngd_rifleman_ak74", "rhsgref_cdf_ngd_rifleman_ak74", "rhsgref_cdf_ngd_rifleman_ak74", "rhsgref_cdf_ngd_rifleman_ak74", "rhsgref_cdf_ngd_rifleman_ak74", "rhsgref_cdf_ngd_rifleman_ak74"],
            [],[],[],[],[],180
        ] call BIS_fnc_spawnGroup;

        {   
            _x assignAsCargo _veh;
            _x moveInCargo _veh;
        } forEach units _cargoGroup;
    };

    _convoy pushBack _veh;
  
} forEach _convoyVehicles;

sleep 3;

(_convoy select 0) setDriveOnPath _points;

for [{_i=0},{_i<count _convoy},{_i=_i+1}] do {
    [{
        params ["_vehicles","_handle"];
        _vehicles params ["_leader","_thisVeh","_follower","_vehicle1"];

        if (isNull (driver _vehicle1) && {speed _thisVeh < 1}) exitWith {
            [_handle] call CBA_fnc_removePerFrameHandler;
        };

        private _distFront = _thisVeh distance _leader;
        private _distBack = _thisVeh distance _follower;

        if (!isNull _leader) then {
            if (_distFront < 5) then {
                _thisVeh limitSpeed 0.5;
            } else {
                _thisVeh setDriveOnPath [getPos _thisVeh,_thisVeh getPos [0.8 * _distFront,_thisVeh getDir _leader]];
                private _speedLimit = if (_distFront > 15) then {if (_distFront < 20) then {30} else {34}} else {26};
                _thisVeh limitSpeed _speedLimit;
            };
        };

        if (!isNull _follower && {_distBack > 50}) then {
            _thisVeh limitSpeed 0.5;
        } else {
            if (isNull _leader) then {
                _thisVeh limitSpeed 30;
            };
        };

    },0.5,[_convoy param [_i-1,objNull],_convoy select _i,_convoy param [_i+1,objNull]],_convoy select 0] call CBA_fnc_addPerFrameHandler;
};

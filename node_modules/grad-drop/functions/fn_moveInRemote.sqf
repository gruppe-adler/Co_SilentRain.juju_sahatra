#include "..\component.hpp"

params ["_unit","_planeInSky", "_giveParachute"];

/*
if (_giveParachute) then {
    if (isClass (configFile >> "CfgPatches" >> "zade_boc") && isPlayer _unit) then {[_unit] call zade_boc_fnc_actionOnChest};
    removeBackpack _unit;
    _unit addBackpackGlobal "NonSteerable_Parachute_F";
};
*/

_planeInSky hideObject false;
_unit allowDamage false;

[{
    params ["_unit", "_planeInSky"];
    _planeInSky distance _unit < 20
},{
    params ["_unit", "_planeInSky"];
    [_unit, "AidlPknlMstpSnonWnonDnon_G01"] remoteExec ["switchMove"];
    detach _unit;
    
    _unit disableAI "MOVE";
    _unit disableAI "ANIM";

    [{
        [_this, "AidlPknlMstpSnonWnonDnon_G01"] remoteExec ["switchMove"];
    }, _unit, 1] call CBA_fnc_waitAndExecute;

    if (!isNil "grad_drop_debug") then {
        private _debugMarker = "VR_3DSelector_01_default_F" createVehicleLocal [0,0,0];
        _debugMarker setPos (getPos _unit);
    };

    private _planeInSky = _planeInBase getVariable ["grad_drop_planeInSky", objNull];

    [{
        params ["_unit", "_planeInSky"];
        (_planeInSky animationPhase "ramp_bottom") > 0
    },
    {
        params ["_unit", "_planeInSky"];

        [_planeInSky] spawn {
            params ["_planeInSky"];
            private _positionRamp = _planeInSky modelToWorld (_planeInSky selectionPosition "ramp_bottom");
            while {!(player getVariable ["GRAD_drop_dropstart", false])} do {
                private _distance = player distance _positionRamp;
                addCamShake [15/_distance, 2, 25];
                sleep 1;
            };
        };
    }, [_unit, _planeInSky]] call CBA_fnc_waitUntilAndExecute; 


    [_unit] call ace_weaponselect_fnc_putWeaponAway;
}, [_unit, _planeInSky]] call CBA_fnc_waitUntilAndExecute; 
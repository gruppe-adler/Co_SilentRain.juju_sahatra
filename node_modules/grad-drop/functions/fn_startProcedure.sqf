#include "..\component.hpp"

params ["_planeInBase", "_waitBeforeJump"];

private _planeInSky = _planeInBase getVariable ["grad_drop_planeInSky", objNull];
private _jm = _planeInSky getVariable ["grad_drop_jumpmaster", objNull];
private _planeLights = _planeInSky getVariable ["grad_drop_lights", []];
_planeLights params ["_lightWhite","_lightGreen","_lightRed"];

if (!isServer) exitWith {};

_lightWhite hideObjectGlobal false;
sleep 4;

["grad_drop_soundChange", [_planeInSky, 3]] call CBA_fnc_serverEvent;

sleep (_waitBeforeJump - 4);


[_planeInSky] remoteExec ["grad_drop_fnc_jump",0,false];

[_jm, "grad_drop_jm0"] remoteExec ["grad_drop_fnc_playSound",0,false];

_lightRed hideObjectGlobal false;
_lightWhite hideObjectGlobal true;

sleep 0.2;

sleep 3;

[_jm, "grad_drop_jm1"] remoteExec ["grad_drop_fnc_playSound",0,false];

sleep 5;

[_jm, "grad_drop_jm2"] remoteExec ["grad_drop_fnc_playSound",0,false];

sleep 10;

[_jm, "grad_drop_jm3"] remoteExec ["grad_drop_fnc_playSound",0,false];


sleep 10;

[_jm, "grad_drop_jm4"] remoteExec ["grad_drop_fnc_playSound",0,false];

/*
[_plane] spawn {
    private _plane = _this select 0;

  
    [] remoteExec ["resetCamShake"];
    
    for "_i" from 0 to 120 do {
        private _distance = 20 + random 70;
        private _position = _plane getRelPos [_distance, ((random 30) - (random 60))];
        private _zPos = getPos _plane select 2;
        _position set [2, (_zPos + random 10 - random 20)];

        private _strength = linearConversion [90, 0, _distance, 0, 7, true];
        private _delay = 0.5 + random 2;
        [_position, _delay, _strength, _plane] remoteExec ["GRAD_drop_fnc_spawnAA", 0,false];
        sleep _delay;
    };
};
*/

sleep 15;

[_jm,"grad_drop_rearDoor"] remoteExec ["grad_drop_fnc_playSound",0,false];

sleep 1.3;


[_jm, "grad_drop_jm5"] remoteExec ["grad_drop_fnc_playSound",0,false];

_planeInSky animate ["ramp_top", 1];
_planeInSky animate ["ramp_bottom", 1];

// exterior sound now
["grad_drop_soundChange", [_planeInSky, 4]] call CBA_fnc_serverEvent;
[_planeInSky] call grad_drop_fnc_preJumpWindSounds;

[[3, 400, 2]] remoteExec ["addCamShake"]; // add stronger shake now


[_planeInSky,_jm] spawn grad_drop_fnc_jumpMasterAnimation;

sleep 36;

[_jm, "grad_drop_jm0"] remoteExec ["grad_drop_fnc_playSound",0,false];

sleep 1;

_lightGreen hideObjectGlobal false;
_lightRed hideObjectGlobal true;

sleep 0.2;

sleep 0.5;

[_jm, "grad_drop_jm6"] remoteExec ["grad_drop_fnc_playSound",0,false];

sleep 3;

[_jm, "grad_drop_jm7"] remoteExec ["grad_drop_fnc_playSound",0,false];

sleep 3.5;

[_jm, "grad_drop_jm8"] remoteExec ["grad_drop_fnc_playSound",0,false];

sleep 3;

[_jm, "grad_drop_jm9"] remoteExec ["grad_drop_fnc_playSound",0,false];

sleep 3.5;

[_jm, "grad_drop_jm10"] remoteExec ["grad_drop_fnc_playSound",0,false];

sleep 3;

[_jm, "grad_drop_jm11"] remoteExec ["grad_drop_fnc_playSound",0,false];

sleep 5;

[_jm, "grad_drop_jm12"] remoteExec ["grad_drop_fnc_playSound",0,false];

// check for all players having jumped
waitUntil {
    private _nearUnits = _planeInSky nearObjects ["Man", 20];
    count (allPlayers arrayIntersect _nearUnits) < 1
};

sleep 3;

// delete soundsources
["grad_drop_soundChange", [_planeInSky, 5]] call CBA_fnc_serverEvent;

sleep 0.5;

deleteVehicle _jm;
{deleteVehicle _x; false} count _planeLights;
deleteVehicle _planeInSky;

private _windSound = _planeInSky getVariable ["grad_drop_soundSourceWind", objNull];
deleteVehicle _windSound;

_planeInBase engineOn false;
private _jmBase = _planeInBase getVariable ["grad_drop_jumpmaster", objNull];
if (!isNull _jmBase) then {
    deleteVehicle _jmBase;
};